{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Locavancy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 50%, #e4e4e7 100%);
      min-height: 100vh;
    }
    
    .ai-container {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(228, 228, 231, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
    }
    
    .job-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(228, 228, 231, 0.4);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .job-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(115, 115, 115, 0.3), transparent);
      transition: left 0.5s;
    }
    
    .job-card:hover::before {
      left: 100%;
    }
    
    .job-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      border-color: rgba(115, 115, 115, 0.3);
    }
    
    .search-container {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(228, 228, 231, 0.5);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
    }
    
    .ai-pulse {
      animation: pulse 3s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; opacity: 0.4; }
      40% { content: '..'; opacity: 0.7; }
      60%, 100% { content: '...'; opacity: 1; }
    }

    .neural-pattern {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.02) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.02) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .agent-badge {
      background: linear-gradient(135deg, rgba(115, 115, 115, 0.1) 0%, rgba(161, 161, 170, 0.1) 100%);
      border: 1px solid rgba(115, 115, 115, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .input-focus:focus {
      outline: none;
      border-color: rgba(115, 115, 115, 0.4);
      box-shadow: 0 0 0 3px rgba(115, 115, 115, 0.1);
    }
    
    .ai-indicator {
      position: relative;
    }
    
    .ai-indicator::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, rgba(115, 115, 115, 0.1), rgba(161, 161, 170, 0.1));
      border-radius: inherit;
      z-index: -1;
    }

    /* AI Loading Animation Styles */
    .ai-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(250, 250, 250, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
    }

    .ai-searching-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .brain-animation {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      position: relative;
    }

    .neural-node {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #6b7280;
      border-radius: 50%;
      animation: neuralPulse 2s infinite;
    }

    .neural-node:nth-child(1) { top: 20%; left: 30%; animation-delay: 0s; }
    .neural-node:nth-child(2) { top: 40%; left: 70%; animation-delay: 0.3s; }
    .neural-node:nth-child(3) { top: 60%; left: 20%; animation-delay: 0.6s; }
    .neural-node:nth-child(4) { top: 30%; left: 60%; animation-delay: 0.9s; }
    .neural-node:nth-child(5) { top: 70%; left: 50%; animation-delay: 1.2s; }

    @keyframes neuralPulse {
      0%, 100% { 
        opacity: 0.3; 
        transform: scale(1);
        background: #9ca3af;
      }
      50% { 
        opacity: 1; 
        transform: scale(1.5);
        background: #4f46e5;
      }
    }

    .progress-bar {
      width: 200px;
      height: 3px;
      background: rgba(156, 163, 175, 0.2);
      border-radius: 2px;
      margin: 24px auto;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6b7280, #4f46e5, #6b7280);
      background-size: 200% 100%;
      animation: progressFlow 2s infinite;
      border-radius: 2px;
    }

    @keyframes progressFlow {
      0% { 
        width: 0%; 
        background-position: -200% 0;
      }
      50% { 
        width: 80%; 
        background-position: 0% 0;
      }
      100% { 
        width: 100%; 
        background-position: 200% 0;
      }
    }

    .ai-status-text {
      animation: fadeInOut 3s infinite;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    .search-ripple {
      position: absolute;
      width: 120px;
      height: 120px;
      border: 2px solid rgba(107, 114, 128, 0.1);
      border-radius: 50%;
      animation: ripple 3s infinite;
    }

    .search-ripple:nth-child(2) { animation-delay: 1s; }
    .search-ripple:nth-child(3) { animation-delay: 2s; }

    @keyframes ripple {
      0% {
        transform: scale(0.8);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }
  </style>
</head>
<body class="gradient-bg">
  <div class="neural-pattern"></div>

  <!-- AI Loading Overlay -->
  <div id="aiLoadingOverlay" class="ai-loading-overlay">
    <div class="ai-searching-container">
      <div class="brain-animation">
        <div class="search-ripple"></div>
        <div class="search-ripple"></div>
        <div class="search-ripple"></div>
        <div class="neural-node"></div>
        <div class="neural-node"></div>
        <div class="neural-node"></div>
        <div class="neural-node"></div>
        <div class="neural-node"></div>
      </div>
      
      <h3 class="text-xl font-medium text-gray-700 mb-2">AI Agent Analyzing</h3>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
      <p id="aiStatusText" class="text-gray-500 font-light ai-status-text">Processing your search criteria...</p>
    </div>
  </div>

  <div class="container mx-auto p-6 relative z-10">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="flex items-center justify-center gap-4 mb-3">
        <div class="ai-indicator w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">
          üíº
        </div>
        <h1 class="text-4xl font-light text-gray-800 tracking-wide">Locavancy</h1>
        <div class="ai-indicator w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">
          üìç
        </div>
      </div>
      <div class="flex items-center justify-center gap-2 mb-2">
        <div class="w-1 h-1 bg-gray-400 rounded-full ai-pulse"></div>
        <p class="text-gray-500 text-sm font-light tracking-wide">AI-Powered Job Discovery</p>
        <div class="w-1 h-1 bg-gray-400 rounded-full ai-pulse" style="animation-delay: 0.5s;"></div>
      </div>
    </div>

    <!-- Search Form -->
    <div class="max-w-3xl mx-auto mb-12">
      <div class="ai-container search-container rounded-2xl p-8">
        <form method="POST" class="flex gap-4" id="searchForm">
          {% csrf_token %}
          <div class="flex-1 relative">
            <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input type="text" name="query" placeholder="Describe your ideal role and location..."
              class="w-full pl-12 pr-4 py-4 rounded-xl border border-gray-200 text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:border-transparent transition-all bg-white/70 backdrop-blur-sm" required>
          </div>
          <button type="submit" id="analyzeButton"
            class="agent-badge px-8 py-4 rounded-xl hover:bg-gray-100 transition-all duration-300 font-medium text-gray-700 flex items-center gap-2">
            <div class="w-4 h-4 text-gray-500">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <span>Analyze</span>
          </button>
        </form>
      </div>
    </div>

    <!-- Jobs Section -->
    {% if has_results %}
      <div class="mb-6">
        <div class="flex items-center justify-center gap-3 mb-8">
          <div class="w-2 h-2 bg-green-400 rounded-full ai-pulse"></div>
          <span class="text-gray-600 font-light tracking-wide">Analysis Complete</span>
          <div class="w-2 h-2 bg-green-400 rounded-full ai-pulse" style="animation-delay: 0.3s;"></div>
        </div>
        
        <div id="jobs" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {% for job in jobs %}
            <div class="job-card p-6 rounded-2xl"
                 data-company="{{ job.company|escapejs }}"
                 data-location="{{ job.location|escapejs }}">
              
              <!-- Job Header -->
              <div class="flex items-start justify-between mb-5">
                <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0H8m8 0v6l-8-6z"></path>
                  </svg>
                </div>
                <div class="agent-badge flex items-center gap-1 text-xs text-gray-600 px-3 py-1 rounded-full">
                  <div class="w-1.5 h-1.5 bg-green-400 rounded-full"></div>
                  <span>Active</span>
                </div>
              </div>
              
              <!-- Job Details -->
              <h2 class="text-lg font-medium text-gray-800 mb-2 leading-snug">{{ job.title }}</h2>
              <p class="text-gray-600 font-light mb-1">{{ job.company }}</p>
              <div class="flex items-center gap-1 text-sm text-gray-500 mb-6">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>{{ job.location }}</span>
              </div>

              <!-- Action Button -->
              <a href="{{ job.url }}" target="_blank"
                class="inline-flex items-center gap-2 agent-badge text-gray-700 px-4 py-2.5 rounded-xl hover:bg-gray-100 transition-all text-sm font-light mb-6 w-full justify-center">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
                <span>View Details</span>
              </a>

              <!-- Location Insights Section -->
              <div class="border-t border-gray-100 pt-4">
                <div class="flex items-center gap-2 mb-3">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                  </svg>
                  <span class="text-sm font-light text-gray-600">Location Intelligence</span>
                </div>
                
                <!-- Nearby places container -->
                <div class="nearby-places text-gray-600 text-sm">
                  <div class="flex items-center gap-2 text-gray-400">
                    <div class="animate-spin w-4 h-4 border border-gray-300 border-t-gray-500 rounded-full"></div>
                    <em class="loading-dots font-light">Processing</em>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% elif request.method == 'POST' %}
      <div class="text-center">
        <div class="ai-container rounded-3xl p-12 max-w-md mx-auto">
          <div class="w-16 h-16 agent-badge rounded-2xl flex items-center justify-center text-2xl mx-auto mb-6">
            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <h3 class="text-gray-700 font-medium mb-2">No Matches Found</h3>
          <p class="text-gray-500 font-light leading-relaxed">The analysis couldn't find opportunities matching your criteria. Try adjusting your search parameters.</p>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- JavaScript for AI Loading Animation and Nearby Places -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const searchForm = document.getElementById('searchForm');
      const aiLoadingOverlay = document.getElementById('aiLoadingOverlay');
      const aiStatusText = document.getElementById('aiStatusText');
      
      const statusMessages = [
        "Processing your search criteria...",
        "Analyzing job market data...",
        "Scanning employer databases...",
        "Matching qualifications...",
        "Evaluating location preferences...",
        "Compiling results..."
      ];
      
      let messageIndex = 0;
      let statusInterval;

      // Handle form submission with AI loading animation
      searchForm.addEventListener('submit', function(e) {
        // Show loading overlay
        aiLoadingOverlay.style.display = 'block';
        
        // Start cycling through status messages
        statusInterval = setInterval(function() {
          messageIndex = (messageIndex + 1) % statusMessages.length;
          aiStatusText.textContent = statusMessages[messageIndex];
        }, 1500);
        
        // The form will submit normally and Django will handle the redirect
        // The overlay will be hidden when the new page loads
      });

      // Hide loading overlay when page loads (in case of back button)
      window.addEventListener('load', function() {
        aiLoadingOverlay.style.display = 'none';
        if (statusInterval) {
          clearInterval(statusInterval);
        }
      });

      // Nearby places functionality (unchanged)
      const jobCards = document.querySelectorAll(".job-card");

      function fetchNearbyPlaces(card) {
        const company = card.dataset.company;
        const location = card.dataset.location;
        const container = card.querySelector(".nearby-places");

        const url = "{% url 'load_nearby_places' %}" +
                    `?company=${encodeURIComponent(company)}&location=${encodeURIComponent(location)}`;

        fetch(url)
          .then(res => res.json())
          .then(data => {
            container.innerHTML = "";
            if (data.nearby_places && data.nearby_places.length > 0) {
              const placesGrid = document.createElement("div");
              placesGrid.className = "grid grid-cols-1 gap-2 mt-2";
              
              data.nearby_places.slice(0, 4).forEach(place => {
                const placeItem = document.createElement("div");
                placeItem.className = "flex items-center gap-3 bg-gray-50/70 backdrop-blur-sm rounded-xl p-3 border border-gray-100";
                
                const icon = document.createElement("div");
                icon.className = "w-6 h-6 bg-gray-100 rounded-lg flex items-center justify-center text-xs text-gray-500";
                icon.textContent = place.category ? place.category.charAt(0).toUpperCase() : "‚Ä¢";
                
                const text = document.createElement("span");
                text.className = "text-xs text-gray-600 truncate font-light";
                text.textContent = place.name + (place.category ? ` ‚Ä¢ ${place.category}` : '');
                
                placeItem.appendChild(icon);
                placeItem.appendChild(text);
                placesGrid.appendChild(placeItem);
              });
              
              if (data.nearby_places.length > 4) {
                const moreItem = document.createElement("div");
                moreItem.className = "text-xs text-gray-500 font-light text-center py-2";
                moreItem.textContent = `+${data.nearby_places.length - 4} more in vicinity`;
                placesGrid.appendChild(moreItem);
              }
              
              container.appendChild(placesGrid);
            } else {
              container.innerHTML = `
                <div class="flex items-center gap-2 text-gray-400 text-xs">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <em class="font-light">Analyzing location data...</em>
                </div>
              `;
            }
          })
          .catch(err => {
            console.error("Nearby places fetch error:", err);
            container.innerHTML = `
              <div class="flex items-center gap-2 text-gray-400 text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <em class="font-light">Location analysis unavailable</em>
              </div>
            `;
          });
      }

      // Fetch in batches to avoid too many simultaneous requests
      const batchSize = 5;
      for (let i = 0; i < jobCards.length; i += batchSize) {
        const batch = Array.from(jobCards).slice(i, i + batchSize);
        batch.forEach(card => fetchNearbyPlaces(card));
      }
    });
  </script>

</body>
</html>
