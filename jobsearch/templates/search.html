{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Locavancy</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">ðŸ”Ž Locavancy</h1>

    <!-- Search Form -->
    <form method="POST" class="flex justify-center mb-6">
      {% csrf_token %}
      <input type="text" name="query" placeholder="e.g. Software Engineer in Bangalore"
        class="w-2/3 p-3 rounded-l-lg border focus:outline-none" required>
      <button type="submit"
        class="bg-blue-600 text-white px-6 rounded-r-lg hover:bg-blue-700">Search</button>
    </form>

    <!-- Jobs Section -->
    {% if has_results %}
      <div id="jobs" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for job in jobs %}
          <div class="job-card bg-white p-6 rounded-xl shadow hover:shadow-lg transition"
               data-company="{{ job.company|escapejs }}"
               data-location="{{ job.location|escapejs }}"
               id="job-{{ forloop.counter }}">
            <h2 class="text-xl font-semibold">{{ job.title }}</h2>
            <p class="text-gray-600">{{ job.company }}</p>
            <p class="text-sm text-gray-500">{{ job.location }}</p>
            <a href="{{ job.url }}" target="_blank"
              class="text-blue-600 underline text-sm">View Job</a>

            <!-- Nearby places container -->
            <div class="nearby-places mt-4 text-gray-700 text-sm">
              <em>Loading nearby places...</em>
            </div>
          </div>
        {% endfor %}
      </div>
    {% elif request.method == 'POST' %}
      <p class="text-center text-gray-600">No jobs found. Try another search.</p>
    {% endif %}
  </div>

  <!-- Async JS for nearby places -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // Grab all job cards
      const jobCards = document.querySelectorAll(".job-card");

      // Helper function to fetch nearby places for a single job
      function fetchNearbyPlaces(card) {
        const company = card.dataset.company;
        const location = card.dataset.location;
        const placesContainer = card.querySelector(".nearby-places");

        // Construct URL using Django {% url %} for safety
        const url = "{% url 'load_nearby_places' %}" +
                    `?company=${encodeURIComponent(company)}&location=${encodeURIComponent(location)}`;

        fetch(url)
          .then(res => res.json())
          .then(data => {
            placesContainer.innerHTML = "";
            if (data.nearby_places && data.nearby_places.length > 0) {
              const ul = document.createElement("ul");
              data.nearby_places.forEach(place => {
                const li = document.createElement("li");
                li.textContent = place.name + (place.category ? ` (${place.category})` : '');
                ul.appendChild(li);
              });
              placesContainer.appendChild(ul);
            } else {
              placesContainer.innerHTML = "<em>No nearby places found.</em>";
            }
          })
          .catch(err => {
            console.error("Nearby places fetch error:", err);
            placesContainer.innerHTML = "<em>Could not load nearby places.</em>";
          });
      }

      // Optionally, fetch in batches to reduce simultaneous requests
      const batchSize = 5; // adjust based on number of jobs
      for (let i = 0; i < jobCards.length; i += batchSize) {
        const batch = Array.from(jobCards).slice(i, i + batchSize);
        batch.forEach(card => fetchNearbyPlaces(card));
      }

    });
  </script>

</body>
</html>
